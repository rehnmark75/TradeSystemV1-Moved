# Azure Backtest Infrastructure
# Optimized for Standard_B16s_v2 (16 vCPUs, 64GB RAM)
# Run with: docker compose -f docker-compose.azure.yml up -d

version: "3.8"

services:
  postgres:
    image: postgres:15
    container_name: postgres
    restart: unless-stopped
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: forex
    ports:
      - "127.0.0.1:5432:5432"  # Only localhost access
    volumes:
      - /data/postgres:/var/lib/postgresql/data
      - /data/sync:/sync  # For data import/export
    shm_size: 16gb  # Shared memory for parallel queries
    command:
      - "postgres"
      # Memory settings optimized for 64GB RAM
      - "-c"
      - "shared_buffers=16GB"
      - "-c"
      - "effective_cache_size=48GB"
      - "-c"
      - "work_mem=512MB"
      - "-c"
      - "maintenance_work_mem=2GB"
      # Parallel query settings for 16 cores
      - "-c"
      - "max_parallel_workers=16"
      - "-c"
      - "max_parallel_workers_per_gather=8"
      - "-c"
      - "max_worker_processes=20"
      - "-c"
      - "parallel_tuple_cost=0.001"
      - "-c"
      - "parallel_setup_cost=100"
      # WAL settings for batch operations
      - "-c"
      - "wal_buffers=256MB"
      - "-c"
      - "checkpoint_completion_target=0.9"
      - "-c"
      - "max_wal_size=4GB"
      # Connection settings
      - "-c"
      - "max_connections=100"
      - "-c"
      - "listen_addresses=*"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  task-worker:
    build:
      context: /data/app
      dockerfile: Dockerfile
    image: task-worker:local
    container_name: task-worker
    restart: "no"  # Don't auto-restart after backtest completes
    volumes:
      - /data/backtest:/app/backtest_output
      - /data/logs:/app/logs
    environment:
      # Database connections
      - DATABASE_URL=postgresql://postgres:postgres@postgres:5432/forex
      - STRATEGY_CONFIG_DATABASE_URL=postgresql://postgres:postgres@postgres:5432/strategy_config
      # Parallel execution settings (optimized for 16 cores)
      - PARALLEL_WORKERS=14
      - CHUNK_DAYS=7
      # Disable features not needed for backtesting
      - ORDER_API_URL=
      - IG_API_KEY=
      - IG_PWD=
      - CLAUDE_API_KEY=
      - MINIO_ENDPOINT=
    depends_on:
      postgres:
        condition: service_healthy
    deploy:
      resources:
        limits:
          cpus: '14'
          memory: 48G
        reservations:
          cpus: '12'
          memory: 40G
    # Keep container running for interactive use
    command: ["tail", "-f", "/dev/null"]

volumes:
  postgres_data:
    driver: local

networks:
  default:
    name: backtest-network
